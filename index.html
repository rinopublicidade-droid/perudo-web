<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perudo (online) ‚Äî copo + anima√ß√£o</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121824; --muted:#9fb0c7; --text:#e8f0ff;
      --acc:#5eead4; --danger:#ff6b6b; --ok:#7CFF7C;
      --glass1: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --shadow: rgba(0,0,0,.30);
    }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: linear-gradient(180deg,#07101a,#0b0f14);
      color:var(--text);
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 16px; }
    h1{ font-size: 20px; margin: 0 0 12px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    .two{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width: 900px){ .two{ grid-template-columns: 1.05fr .95fr; } }

    .card{
      background: rgba(18,24,36,.90);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }

    input, button, select{
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      font-size: 16px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }
    button{ cursor:pointer; background: rgba(94,234,212,.12); border-color: rgba(94,234,212,.35); }
    button.primary{ background: rgba(94,234,212,.22); }
    button.danger{ background: rgba(255,107,107,.14); border-color: rgba(255,107,107,.35); }
    button.ghost{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .muted{ color: var(--muted); font-size: 13px; line-height:1.35; }
    .small{ font-size: 12px; color: rgba(255,255,255,.65); }

    .pill{
      padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      font-size: 13px;
    }

    .log{ max-height: 220px; overflow:auto; font-size: 14px; }
    .log div{ padding: 8px 0; border-bottom:1px solid rgba(255,255,255,.06); }

    /* ====== √Årea do copo e dados ====== */
    .cupArea{
      position: relative;
      height: 220px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.06);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
    }

    .diceGrid{
      position:absolute;
      left: 14px; right: 14px; bottom: 14px;
      display:flex; flex-wrap:wrap; gap:8px;
      align-items:center;
      transition: filter .25s ease, opacity .25s ease, transform .25s ease;
      z-index: 1;
    }
    .die{
      width:42px; height:42px; border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size: 18px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 20px rgba(0,0,0,.20);
      user-select:none;
    }

    /* Copo (overlay) */
    .cup{
      position:absolute;
      width: 210px;
      height: 240px;
      right: -24px;
      top: -20px;
      transform: rotate(12deg);
      z-index: 5;
      pointer-events:none;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.35));
      transition: transform .35s ease;
    }
    .cup svg{ width:100%; height:100%; display:block; }

    /* Quando escondido: copo ‚Äúcobre‚Äù e dados ficam blur */
    .hiddenDice .diceGrid{
      filter: blur(10px);
      opacity: .25;
      transform: translateY(8px) scale(.98);
    }
    .hiddenDice .cup{
      transform: rotate(10deg) translateY(0px) translateX(0px);
    }

    /* Quando revelado: copo ‚Äúsobe‚Äù um pouco pra mostrar os dados */
    .revealedDice .cup{
      transform: rotate(10deg) translateY(-54px) translateX(14px);
    }
    .revealedDice .diceGrid{
      filter:none;
      opacity:1;
      transform:none;
    }

    /* ====== Anima√ß√£o de sacudir ====== */
    @keyframes shakeCup {
      0%   { transform: rotate(12deg) translate(0,0); }
      10%  { transform: rotate(6deg)  translate(-6px, 2px); }
      20%  { transform: rotate(18deg) translate(8px, -2px); }
      30%  { transform: rotate(9deg)  translate(-10px, 2px); }
      40%  { transform: rotate(16deg) translate(10px, 0px); }
      50%  { transform: rotate(8deg)  translate(-8px, -2px); }
      60%  { transform: rotate(20deg) translate(10px, 3px); }
      70%  { transform: rotate(10deg) translate(-6px, 0px); }
      80%  { transform: rotate(16deg) translate(6px, -2px); }
      90%  { transform: rotate(10deg) translate(-3px, 1px); }
      100% { transform: rotate(12deg) translate(0,0); }
    }
    .shaking .cup{
      animation: shakeCup 850ms ease-in-out 1;
    }
    .flash{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 30% 40%, rgba(94,234,212,.18), transparent 55%),
                  radial-gradient(circle at 70% 65%, rgba(255,255,255,.08), transparent 55%);
      opacity:0;
      z-index: 2;
      transition: opacity .2s ease;
      pointer-events:none;
    }
    .shaking .flash{ opacity: 1; }

    a{ color: var(--acc); text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üé≤ Perudo ‚Äî sala online (copo + anima√ß√£o)</h1>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="pill" id="roomPill">Sala: ‚Äî</span>
            <span class="pill" id="mePill">Voc√™: ‚Äî</span>
            <span class="pill" id="turnPill">Vez: ‚Äî</span>
          </div>
          <button id="copyLinkBtn" class="primary" disabled>Copiar link da sala</button>
        </div>
        <div class="muted" style="margin-top:10px">
          Implementado: <b>lances</b> (qtd+face), <b>DUDO</b>, perde 1 dado, elimina em 0.
          <br/>Simplifica√ß√£o: <b>1 √© coringa sempre</b> (sem Palifico/Calza).
        </div>
      </div>

      <div class="two">
        <div class="card">
          <h2 style="margin:0 0 10px; font-size:16px">Entrar / Criar sala</h2>
          <div class="row">
            <input id="nameInput" placeholder="Seu nome" maxlength="18" />
            <button id="createBtn" class="primary">Criar sala</button>
            <input id="roomInput" placeholder="C√≥digo da sala (opcional)" maxlength="8" />
            <button id="joinBtn">Entrar</button>
          </div>
          <div class="muted" style="margin-top:10px">
            Ao criar, voc√™ vira <b>host</b>. Depois clique em <b>Iniciar jogo</b>.
          </div>

          <div style="margin-top:14px" class="row">
            <button id="startBtn" class="primary" disabled>Iniciar jogo</button>
            <button id="resetBtn" class="danger" disabled>Resetar sala</button>
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 10px; font-size:16px">Jogadores</h2>
          <div id="playersList" class="muted">‚Äî</div>
        </div>
      </div>

      <div class="two">
        <div class="card">
          <h2 style="margin:0 0 10px; font-size:16px">Sua m√£o (secreta)</h2>
          <div class="row">
            <button id="rollBtn" class="primary" disabled>Rolar meus dados</button>
            <button id="toggleRevealBtn" class="ghost" disabled>Revelar meus dados</button>
            <span class="small" id="diceCountInfo">‚Äî</span>
          </div>

          <div id="cupArea" class="cupArea hiddenDice">
            <div class="flash"></div>
            <div class="diceGrid" id="myDice"></div>

            <!-- Copo em SVG (simples e bonito) -->
            <div class="cup" aria-hidden="true">
              <svg viewBox="0 0 220 260" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0" stop-color="rgba(255,255,255,.22)"/>
                    <stop offset="1" stop-color="rgba(255,255,255,.06)"/>
                  </linearGradient>
                  <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="rgba(94,234,212,.18)"/>
                    <stop offset="1" stop-color="rgba(255,255,255,.05)"/>
                  </linearGradient>
                </defs>

                <!-- Corpo do copo -->
                <path d="M55 40
                         C70 20, 150 20, 165 40
                         L190 210
                         C192 228, 178 242, 160 242
                         L60 242
                         C42 242, 28 228, 30 210
                         Z"
                      fill="url(#g1)"
                      stroke="rgba(255,255,255,.16)"
                      stroke-width="2"/>

                <!-- Brilho -->
                <path d="M72 55
                         C92 35, 132 35, 150 55
                         L170 205
                         C172 218, 162 228, 150 228
                         L85 228
                         C72 228, 62 218, 64 205
                         Z"
                      fill="url(#g2)"
                      opacity="0.55"/>

                <!-- Borda -->
                <path d="M55 40 C70 20,150 20,165 40"
                      stroke="rgba(255,255,255,.22)"
                      stroke-width="6"
                      stroke-linecap="round"/>
              </svg>
            </div>
          </div>

          <div class="muted" style="margin-top:10px">
            Por padr√£o, seus dados ficam <b>cobertos</b>. Toque em <b>Revelar meus dados</b> pra ver.
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 10px; font-size:16px">Aposta (lance)</h2>
          <div class="row">
            <select id="qtySel" disabled></select>
            <select id="faceSel" disabled>
              <option value="2">Face 2</option>
              <option value="3">Face 3</option>
              <option value="4">Face 4</option>
              <option value="5">Face 5</option>
              <option value="6">Face 6</option>
            </select>
            <button id="bidBtn" class="primary" disabled>Dar lance</button>
            <button id="dudoBtn" class="danger" disabled>DUDO!</button>
          </div>
          <div class="muted" style="margin-top:10px" id="lastBidInfo">√öltimo lance: ‚Äî</div>
          <div class="muted" style="margin-top:6px">
            Lance v√°lido precisa ser <b>maior</b> que o anterior (mais quantidade, ou mesma quantidade com face maior).
          </div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px; font-size:16px">Log</h2>
        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <div class="muted">
          ‚öôÔ∏è Este HTML usa Firebase Firestore como ‚Äúsala online‚Äù.  
          Se quiser, eu adiciono: <b>Calza</b>, <b>Palifico</b> e a regra cl√°ssica do <b>1</b>.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
      collection, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase config (suas infos)
    const firebaseConfig = {
      apiKey: "AIzaSyAjZXA0w9IltKPE6V-eSKM8J1M0UbPyVzk",
      authDomain: "perudo-f7af1.firebaseapp.com",
      projectId: "perudo-f7af1",
      storageBucket: "perudo-f7af1.firebasestorage.app",
      messagingSenderId: "215515744682",
      appId: "1:215515744682:web:f03966bf1733da044003d3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const rand = (n) => Math.floor(Math.random() * n);
    const rid = (len=6) => Array.from({length:len}, () => "ABCDEFGHJKMNPQRSTUVXYZ23456789"[rand(30)]).join("");
    const nowISO = () => new Date().toISOString();

    function pushLog(text) {
      const el = $("log");
      const line = document.createElement("div");
      line.textContent = text;
      el.prepend(line);
    }

    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    function renderDice(arr) {
      const box = $("myDice");
      box.innerHTML = "";
      arr.forEach(v => {
        const d = document.createElement("div");
        d.className = "die";
        d.textContent = v;
        box.appendChild(d);
      });
    }

    function higherThan(prev, next) {
      if (!prev) return true;
      if (next.qty > prev.qty) return true;
      if (next.qty === prev.qty && next.face > prev.face) return true;
      return false;
    }

    function countTotalDice(players) {
      return Object.values(players).reduce((acc,p) => acc + (p.diceCount||0), 0);
    }

    // 1 √© coringa sempre (simplifica√ß√£o)
    function countBid(players, bid) {
      const face = bid.face;
      let total = 0;
      for (const p of Object.values(players)) {
        const dice = p.lastRoll || [];
        for (const v of dice) {
          if (v === 1) total++;
          else if (v === face) total++;
        }
      }
      return total;
    }

    // ===== State =====
    let roomId = null;
    let meId = localStorage.getItem("perudo_meId") || crypto.randomUUID();
    localStorage.setItem("perudo_meId", meId);

    let unsub = null;

    // UI state (local)
    let myReveal = false;
    let rollingLock = false;

    function setRevealState(on) {
      myReveal = on;
      const cupArea = $("cupArea");
      cupArea.classList.toggle("hiddenDice", !on);
      cupArea.classList.toggle("revealedDice", on);
      $("toggleRevealBtn").textContent = on ? "Esconder meus dados" : "Revelar meus dados";
    }

    function roomRef() { return doc(db, "perudo_rooms", roomId); }
    function playerRef(pid) { return doc(db, "perudo_rooms", roomId, "players", pid); }
    function playersCol() { return collection(db, "perudo_rooms", roomId, "players"); }

    async function ensureRoomExists(newRoomId) {
      roomId = newRoomId;
      $("roomPill").textContent = "Sala: " + roomId;

      const snap = await getDoc(roomRef());
      if (!snap.exists()) {
        await setDoc(roomRef(), {
          createdAt: serverTimestamp(),
          hostId: meId,
          status: "lobby", // lobby | playing
          turnOrder: [],
          turnIndex: 0,
          round: 0,
          lastBid: null,
          lastBidBy: null,
          reveal: false,
          lastActionAt: nowISO()
        });
      }
    }

    async function joinRoom() {
      const name = $("nameInput").value.trim();
      if (!name) return alert("Digite seu nome.");
      if (!roomId) return alert("Sala inv√°lida.");

      await setDoc(playerRef(meId), {
        id: meId,
        name,
        diceCount: 5,
        lastRoll: [],
        alive: true,
        joinedAt: serverTimestamp()
      }, { merge: true });

      $("mePill").textContent = "Voc√™: " + name;

      const url = new URL(location.href);
      url.searchParams.set("room", roomId);
      history.replaceState({}, "", url.toString());

      $("copyLinkBtn").disabled = false;
      $("startBtn").disabled = false;
      $("resetBtn").disabled = false;

      $("toggleRevealBtn").disabled = false;
      setRevealState(false); // come√ßa escondido

      subscribe();
    }

    async function subscribe() {
      if (unsub) unsub();
      unsub = onSnapshot(roomRef(), async (snap) => {
        if (!snap.exists()) return;
        const room = snap.data();

        const pSnap = await getDocs(playersCol());
        const players = {};
        pSnap.forEach(d => players[d.id] = d.data());

        renderPlayers(room, players);
        updateUI(room, players);

        // Render meus dados SEMPRE (visual local), mas pode estar escondido pela UI
        renderDice(players[meId]?.lastRoll || []);
      });
    }

    function renderPlayers(room, players) {
      const list = $("playersList");
      const entries = Object.values(players).sort((a,b) => (a.name||"").localeCompare(b.name||""));
      if (!entries.length) { list.textContent = "‚Äî"; return; }

      const hostId = room.hostId;
      const turnId = room.turnOrder?.[room.turnIndex] || null;

      list.innerHTML = entries.map(p => {
        const host = p.id === hostId ? " üëë" : "";
        const turn = p.id === turnId ? " ‚ñ∂Ô∏è" : "";
        const alive = p.alive ? "" : " (eliminado)";
        return `<div>‚Ä¢ <b>${escapeHtml(p.name||"")}</b>${host}${turn} ‚Äî dados: ${p.diceCount ?? 0}${alive}</div>`;
      }).join("");
    }

    function updateUI(room, players) {
      $("turnPill").textContent = "Vez: " + (players[room.turnOrder?.[room.turnIndex]]?.name || "‚Äî");

      const me = players[meId];
      const isHost = room.hostId === meId;
      $("startBtn").disabled = !isHost || room.status !== "lobby";
      $("resetBtn").disabled = !isHost;

      const playing = room.status === "playing";
      const myTurn = playing && room.turnOrder?.[room.turnIndex] === meId;

      const myDiceCount = me?.diceCount ?? 0;
      $("diceCountInfo").textContent = playing ? `Voc√™ tem ${myDiceCount} dado(s).` : "‚Äî";

      // qty options
      const maxPossible = Math.max(1, countTotalDice(players));
      const qtySel = $("qtySel");
      qtySel.innerHTML = "";
      for (let i=1;i<=maxPossible;i++){
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `Qtd ${i}`;
        qtySel.appendChild(opt);
      }

      $("rollBtn").disabled = !playing || !me?.alive || rollingLock;

      $("qtySel").disabled = !myTurn;
      $("faceSel").disabled = !myTurn;
      $("bidBtn").disabled = !myTurn;
      $("dudoBtn").disabled = !myTurn || !room.lastBid;

      if (room.lastBid) {
        const by = players[room.lastBidBy]?.name || "‚Äî";
        $("lastBidInfo").innerHTML = `√öltimo lance: <b>${room.lastBid.qty}</b> de <b>${room.lastBid.face}</b> (por <b>${escapeHtml(by)}</b>)`;
      } else {
        $("lastBidInfo").textContent = "√öltimo lance: ‚Äî";
      }
    }

    // ===== Copo: anima√ß√£o =====
    async function animateCupShake() {
      const cupArea = $("cupArea");
      cupArea.classList.add("shaking");
      await new Promise(r => setTimeout(r, 900));
      cupArea.classList.remove("shaking");
    }

    // ===== Game actions =====
    async function startGame() {
      const pSnap = await getDocs(playersCol());
      const players = [];
      pSnap.forEach(d => players.push(d.data()));
      const alive = players.filter(p => p.alive !== false && (p.diceCount ?? 0) > 0);
      if (alive.length < 2) return alert("Precisa de pelo menos 2 jogadores.");

      const order = alive.map(p => p.id);
      for (let i=order.length-1;i>0;i--){
        const j = rand(i+1);
        [order[i], order[j]] = [order[j], order[i]];
      }

      await updateDoc(roomRef(), {
        status: "playing",
        turnOrder: order,
        turnIndex: 0,
        round: 1,
        lastBid: null,
        lastBidBy: null,
        reveal: false,
        lastActionAt: nowISO()
      });

      // come√ßa escondido no meu cliente
      setRevealState(false);
      pushLog("üé¨ Jogo iniciado! Ordem sorteada.");
    }

    async function resetRoom() {
      if (!confirm("Resetar a sala? (zera jogo e dados)")) return;

      const pSnap = await getDocs(playersCol());
      for (const d of pSnap.docs) {
        await updateDoc(d.ref, { diceCount: 5, lastRoll: [], alive: true });
      }
      await updateDoc(roomRef(), {
        status: "lobby",
        turnOrder: [],
        turnIndex: 0,
        round: 0,
        lastBid: null,
        lastBidBy: null,
        reveal: false,
        lastActionAt: nowISO()
      });
      setRevealState(false);
      pushLog("‚ôªÔ∏è Sala resetada.");
    }

    async function rollMyDice() {
      if (rollingLock) return;
      rollingLock = true;
      $("rollBtn").disabled = true;

      // sempre esconde antes de rolar (fica mais ‚Äújogo‚Äù)
      setRevealState(false);

      // anima copo
      await animateCupShake();

      const snap = await getDoc(playerRef(meId));
      if (!snap.exists()) { rollingLock=false; return; }
      const me = snap.data();
      if (!me.alive || (me.diceCount ?? 0) <= 0) { rollingLock=false; return; }

      const dice = Array.from({length: me.diceCount}, () => rand(6)+1);
      await updateDoc(playerRef(meId), { lastRoll: dice });

      pushLog("üé≤ Voc√™ rolou seus dados. (toque em Revelar para ver)");
      rollingLock = false;
      $("rollBtn").disabled = false;
    }

    async function bid() {
      const roomSnap = await getDoc(roomRef());
      const room = roomSnap.data();

      const turnId = room.turnOrder?.[room.turnIndex];
      if (turnId !== meId) return alert("N√£o √© sua vez.");

      const next = { qty: parseInt($("qtySel").value,10), face: parseInt($("faceSel").value,10) };
      const prev = room.lastBid;

      if (!higherThan(prev, next)) {
        return alert("Lance inv√°lido. Ele precisa ser maior que o √∫ltimo lance.");
      }

      await updateDoc(roomRef(), {
        lastBid: next,
        lastBidBy: meId,
        reveal: false,
        turnIndex: (room.turnIndex + 1) % room.turnOrder.length,
        lastActionAt: nowISO()
      });

      pushLog(`üì¢ ${$("mePill").textContent.replace("Voc√™: ","")} apostou ${next.qty} de ${next.face}.`);
    }

    async function dudo() {
      const roomSnap = await getDoc(roomRef());
      const room = roomSnap.data();
      const bid = room.lastBid;
      if (!bid) return;

      const turnId = room.turnOrder?.[room.turnIndex];
      if (turnId !== meId) return alert("N√£o √© sua vez.");

      // carrega players
      const pSnap = await getDocs(playersCol());
      const players = {};
      pSnap.forEach(d => players[d.id] = d.data());

      const total = countBid(players, bid);
      const bidderId = room.lastBidBy;
      const callerId = meId;

      const bidTrue = total >= bid.qty;
      const loserId = bidTrue ? callerId : bidderId;

      const loser = players[loserId];
      let newCount = Math.max(0, (loser.diceCount ?? 0) - 1);
      const eliminated = newCount === 0;

      await updateDoc(playerRef(loserId), {
        diceCount: newCount,
        alive: !eliminated
      });

      // remove eliminados da ordem
      const newPlayersSnap = await getDocs(playersCol());
      const newPlayers = {};
      newPlayersSnap.forEach(d => newPlayers[d.id] = d.data());

      let order = room.turnOrder.slice();
      order = order.filter(pid => (newPlayers[pid]?.alive ?? false) && (newPlayers[pid]?.diceCount ?? 0) > 0);

      // se sobrou 1, fim
      if (order.length === 1) {
        const winnerName = newPlayers[order[0]]?.name || "Algu√©m";
        await updateDoc(roomRef(), {
          status: "lobby",
          turnOrder: [],
          turnIndex: 0,
          lastBid: null,
          lastBidBy: null,
          reveal: true,
          lastActionAt: nowISO()
        });
        pushLog(`üèÜ ${winnerName} venceu! (Sala voltou ao lobby)`);
        return;
      }

      // loser come√ßa a pr√≥xima rodada (se vivo; sen√£o, o pr√≥ximo)
      let startIdx = order.indexOf(loserId);
      if (startIdx < 0) startIdx = 0;

      await updateDoc(roomRef(), {
        turnOrder: order,
        turnIndex: startIdx,
        round: (room.round || 1) + 1,
        lastBid: null,
        lastBidBy: null,
        reveal: true,
        lastActionAt: nowISO()
      });

      const bidderName = players[bidderId]?.name || "‚Äî";
      const callerName = players[callerId]?.name || "‚Äî";
      const loserName  = players[loserId]?.name || "‚Äî";

      pushLog(`üß® DUDO! ${callerName} duvidou do lance de ${bidderName}. Contagem: ${total} (inclui coringas 1).`);
      pushLog(`${bidTrue ? "‚úÖ" : "‚ùå"} Lance ${bidTrue ? "VERDADEIRO" : "FALSO"}. ${loserName} perde 1 dado. ${eliminated ? "‚ò†Ô∏è Eliminado!" : ""}`);
      pushLog(`üëÄ (Momento de revela√ß√£o) Agora √© nova rodada ‚Äî role de novo!`);

      // limpa dados rolados (for√ßa nova rolagem)
      for (const pid of Object.keys(newPlayers)) {
        if (newPlayers[pid]?.alive) {
          await updateDoc(playerRef(pid), { lastRoll: [] });
        }
      }

      // no meu cliente, volta a esconder
      setRevealState(false);
    }

    // ===== UI events =====
    function setRoomFromInputsOrUrl() {
      const url = new URL(location.href);
      const fromUrl = url.searchParams.get("room");
      if (fromUrl) {
        roomId = fromUrl.toUpperCase();
        $("roomInput").value = roomId;
        $("roomPill").textContent = "Sala: " + roomId;
      }
    }

    $("createBtn").addEventListener("click", async () => {
      const name = $("nameInput").value.trim();
      if (!name) return alert("Digite seu nome.");
      const newRoom = rid(6);
      await ensureRoomExists(newRoom);
      await joinRoom();
      pushLog("‚úÖ Sala criada.");
    });

    $("joinBtn").addEventListener("click", async () => {
      const name = $("nameInput").value.trim();
      if (!name) return alert("Digite seu nome.");
      const code = ($("roomInput").value.trim() || "").toUpperCase();
      if (!code) return alert("Digite o c√≥digo da sala (ou clique Criar).");
      await ensureRoomExists(code);
      await joinRoom();
      pushLog("‚úÖ Voc√™ entrou na sala.");
    });

    $("startBtn").addEventListener("click", startGame);
    $("resetBtn").addEventListener("click", resetRoom);
    $("rollBtn").addEventListener("click", rollMyDice);
    $("bidBtn").addEventListener("click", bid);
    $("dudoBtn").addEventListener("click", dudo);

    $("toggleRevealBtn").addEventListener("click", () => {
      setRevealState(!myReveal);
    });

    $("copyLinkBtn").addEventListener("click", async () => {
      const url = new URL(location.href);
      url.searchParams.set("room", roomId);
      await navigator.clipboard.writeText(url.toString());
      alert("Link copiado! Envie no WhatsApp.");
    });

    // init
    setRoomFromInputsOrUrl();
    if (roomId) {
      await ensureRoomExists(roomId);
      $("copyLinkBtn").disabled = false;
      $("startBtn").disabled = false;
      $("resetBtn").disabled = false;
      $("toggleRevealBtn").disabled = false;
      setRevealState(false);
      subscribe();
    } else {
      // sem sala: deixa padr√£o escondido
      setRevealState(false);
    }
  </script>
</body>
</html>
